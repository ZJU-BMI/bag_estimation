---
title: "drug_repurposing_for_brain_aging"
output:
  pdf_document: default
  html_notebook: default
---

Based on the output of dgidb by inputting the MR genes, drugs were annotated with Drugbank and ChEMBL.

The drugbank and ChEMBL databases should be localized before running this code. 

## The DgiDB output
```{r}
dgidb_raw <- readxl::read_xlsx("./data/mr_eqtl_significant-20230722.xlsx", sheet="dgidb")
dgidb_raw
```

## Annotating drugs using drugbank
```{r}
library(dplyr)

# change parameters based on the deployment of drugbank
con <- DBI::dbConnect(RMariaDB::MariaDB(),
                      dbname="drugbank",
                      host = "localhost",
                      user = "zjia" )

drug <- tbl(con, "drug")%>% collect() 
drug_groups <- tbl(con, "drug_groups") %>% collect() 
drug_groups <- dplyr::group_by(drug_groups, `drugbank-id`) %>% dplyr::summarise(status=paste(group, collapse = ","))
drug_pharmacology <- tbl(con, "drug_pharmacology") %>% collect() 
drug_external_identifiers <- tbl(con, "drug_external_identifiers") %>% collect() 

MRgene_DrugBankdrugs <-  dplyr::rename(drug, `drugbank-id`=primary_key ) %>% 
    dplyr::mutate(names=tolower(name) ) %>% 
    # dplyr::filter(drug, names %in%  tmp ) %>% 
    dplyr::left_join(drug_groups ) %>%
    dplyr::left_join(drug_pharmacology, by=c("drugbank-id"="drugbank_id") ) %>%
    collect() 

# only keep drugs in drugbank.
MRgene_DrugBankdrugs_refined <- dplyr::filter(MRgene_DrugBankdrugs, names %in% dgidb_raw$drug ) %>% 
    dplyr::select(`drugbank-id`, names, status, description, indication, mechanism_of_action, toxicity) %>% 
    dplyr::mutate(description=gsub("\r+|\n+",".",description), indication=gsub("\r+|\n+",".",indication), 
                  mechanism_of_action=gsub("\r+|\n+",".",mechanism_of_action), toxicity=gsub("\r+|\n+",".",toxicity) )
```

## drugbankID to ChEMBLID
```{r}
drugbID_chEMBLID <- dplyr::filter(drug_external_identifiers, resource=="ChEMBL", parent_key %in% MRgene_DrugBankdrugs_refined$`drugbank-id` ) %>% 
    dplyr::rename(`drugbank-id`=parent_key) %>% dplyr::select(-resource)

# add CHEMBL550495 for Methylene blue
drugbID_chEMBLID <- rbind(drugbID_chEMBLID, c("CHEMBL550495", "DB09241") )

MRgene_DrugBankdrugs_refined <- dplyr::left_join(MRgene_DrugBankdrugs_refined, drugbID_chEMBLID )

################################################################################

dgidb_drugbank <- dplyr::left_join(dgidb_raw, MRgene_DrugBankdrugs_refined, by=c("drug"="names")) 

DBI::dbDisconnect(con)
################################################################################
# indication of ChEMBLID
# change parameters based on the deployment of chEMBL
con1 <- DBI::dbConnect(RMariaDB::MariaDB(),
                      dbname="chEMBL",
                      host = "localhost",
                      user = "zjia" )

drug_indication <- tbl(con1, "drug_indication") %>% collect() 
molecule_dictionary <- tbl(con1, "molecule_dictionary") %>% collect() 

chemblID_ind <- dplyr::left_join(drug_indication, molecule_dictionary) %>% 
    dplyr::filter(chembl_id %in% as.vector(na.omit(MRgene_DrugBankdrugs_refined$identifier)) ) %>% 
    dplyr::mutate(drug=tolower(pref_name) )

gene_drug_indication <- dplyr::select(dgidb_drugbank, gene, drug, `drugbank-id`, interaction_types ) %>% 
    dplyr::left_join(drugbID_chEMBLID) %>% 
    dplyr::left_join(chemblID_ind, by=c("identifier"="chembl_id" ) )

# merge multi-row indication into one row
gene_drug_Merged_indication <- dplyr::select(gene_drug_indication, gene, drug.x, interaction_types,
                                      identifier, max_phase_for_ind, efo_term, max_phase) %>% 
    group_by(gene, drug.x) %>% 
    dplyr::summarise(efo_terms=paste(efo_term, collapse = ","), interaction_types=unique(interaction_types),
                     max_phase_for_ind=paste(max_phase_for_ind, collapse = ","), max_phase=unique(max_phase) )

DBI::dbDisconnect(con1)
```

## add MR + coloc and beta infor.
```{r}

MR3_raw <- readxl::read_xlsx("./data/mr_eqtl_significant-20230722.xlsx", sheet= "BAG > 3 years" )
MRm3_raw <- readxl::read_xlsx("./data/mr_eqtl_significant-20230722.xlsx", sheet= "BAG < -3 years" )
coloc3_raw <- readxl::read_xlsx("./data/mr_eqtl_significant-20230722.xlsx", sheet= "BAG > 3 years coloc" )
colocm3_raw <- readxl::read_xlsx("./data/mr_eqtl_significant-20230722.xlsx", sheet= "BAG < -3 years coloc" )


MR_coloc3 <- dplyr::left_join(MR3_raw[,c("eQTL_type", "hgnc_names", "b")], coloc3_raw[,c("hgnc_names","SNP.PP.H4")] ) %>% 
    dplyr::rename(b_3=b, PPH4_3=SNP.PP.H4 )

MR_colocm3 <- dplyr::left_join(MRm3_raw[,c("eQTL_type", "hgnc_names", "b")], colocm3_raw[,c("hgnc_names","SNP.PP.H4")] ) %>% 
    dplyr::rename(b_m3=b, PPH4_m3=SNP.PP.H4 )

# MR pQTL results
MR_pQTL_3 <- readxl::read_xlsx("./data/MR_pQTL.xlsx", sheet="BAG > 3 years_pQTL") %>% 
    dplyr::select(hgnc_names, BETA, SNP.PP.H4) %>% dplyr::rename(pQTL_3_beta=BETA, pQTL_3_SNP.PP.H4=SNP.PP.H4)

MR_pQTL_m3 <- readxl::read_xlsx("./data/MR_pQTL.xlsx", sheet="BAG < -3 years_pQTL") %>% 
    dplyr::select(hgnc_names, BETA, SNP.PP.H4) %>% dplyr::rename(pQTL_m3_beta=BETA, pQTL_m3_SNP.PP.H4=SNP.PP.H4)


MR_coloc_res <- dplyr::full_join(MR_coloc3, MR_colocm3) %>% 
    dplyr::left_join(MR_pQTL_3) %>% 
    dplyr::left_join(MR_pQTL_m3) %>% 
    dplyr::rename(gene=hgnc_names) 

MR_coloc_res_stat <- dplyr::group_by(MR_coloc_res, gene) %>% 
    tidyr::pivot_longer(cols=3:ncol(.), names_to="evidenceFrom", values_to="value" ) %>% 
    dplyr::summarise(evidence_num=sum(!is.na(value)) )

MR_coloc_res <- dplyr::left_join(MR_coloc_res, MR_coloc_res_stat)
# the evidence of pQTL_m3_beta was not counted due to the regulation direction and only 1 SNPs. 
MR_coloc_res[8, "evidence_num"] <- 4


```

## Supplementary Data 12
```{R}
MR_coloc_res
readr::write_tsv(MR_coloc_res, file="./results/MR_coloc_res.tsv", na="")
```

## Add anti-aging drugs infor.
```{r}

anti_aging_drugs_raw <-  readxl::read_xlsx("./data/mr_eqtl_significant-20230722.xlsx", sheet="antiaging_drugs")
anti_aging_drugs <- anti_aging_drugs_raw$drug

gene_drug_indication_beta <- dplyr::left_join(gene_drug_indication, MR_coloc_res) %>% 
    dplyr::left_join(anti_aging_drugs_raw, by=c("drug.x"="drug") ) %>% 
    dplyr::mutate(agingdrug=ifelse(!is.na(PMIDs), "Y", "" ) )

#merge indications 
# ro-5458640 is a antibody drug in clinical trails not in drugbank
gene_drug_Mergedindication_beta <- dplyr::left_join(gene_drug_Merged_indication, MR_coloc_res) %>% 
    dplyr::left_join(anti_aging_drugs_raw, by=c("drug.x"="drug") ) %>% 
    dplyr::mutate(agingdrug=ifelse(!is.na(PMIDs), "Y", "" ) ) %>% 
    dplyr::filter(max_phase >= 0.5 | drug.x == "ro-5458640" )

```


## add direction based on beta and interaction_type
```{r}
gene_drug_Mergedindication_beta_direction <- dplyr::mutate(gene_drug_Mergedindication_beta, 
     direction= dplyr::if_else( !is.na(interaction_types) & b_3 >0 & grepl("antagonist|inhibitor|inverse agonist", interaction_types) |
                         !is.na(interaction_types) & b_3 <0 & grepl("^agonist|partial agonist|activator", interaction_types) | 
                         !is.na(interaction_types) & b_m3 >0 & grepl("^agonist|partial agonist|activator", interaction_types) |
                         !is.na(interaction_types) & b_m3 <0 & grepl("antagonist|inhibitor", interaction_types), 
                         "Y", "", "N")  )

# revise due to two-direction drugs
toberevised_ids <- gene_drug_Mergedindication_beta_direction$interaction_types %in% c("inhibitor|inducer", "antagonist|partial agonist", "partial agonist|antagonist") %>%  which
gene_drug_Mergedindication_beta_direction[toberevised_ids,"direction"] <- "N"

# set NA interaction_types to NA direction
gene_drug_Mergedindication_beta_direction[which(is.na(gene_drug_Mergedindication_beta_direction$interaction_types)),"direction"] <- NA
gene_drug_Mergedindication_beta_direction[which(grepl("unknown", gene_drug_Mergedindication_beta_direction$interaction_types) ),"direction"] <- NA

# set opposite to NO
shouldnot_Omit_ID1 <- which(gene_drug_Mergedindication_beta_direction$interaction_types =="antagonist" & gene_drug_Mergedindication_beta_direction$b_3 < 0)
shouldnot_Omit_ID2 <- which(gene_drug_Mergedindication_beta_direction$interaction_types =="inducer" & gene_drug_Mergedindication_beta_direction$b_3 > 0)

gene_drug_Mergedindication_beta_direction[c(shouldnot_Omit_ID1, shouldnot_Omit_ID2),"direction"] <- "N"
```


## the data for plotting Figure 5, Table 1, Supplementary Data 11
```{r}
gene_drug_Mergedindication_beta_direction
readr::write_tsv(gene_drug_Mergedindication_beta_direction, file="./results/gene_drug_Mergedindication_beta_direction.tsv", na="")

```

# session
```{r}
sessioninfo::session_info()
```